# Battlefield Portal Raycast Mesher

A specialized tool for reconstructing 3D terrain from Battlefield Portal raycast data.

This tool processes raycast hit/miss data generated by [this Portal script](https://gist.github.com/dfanz0r/598cfff02beafc92e241e76fb3206fe1) and converts it into high-quality 3D meshes (`.glb` or `.obj`). It is designed for progressive detail accumulation, allowing you to build high-fidelity maps of Battlefield levels over multiple scanning sessions.

## Key Features

- **Progressive Accumulation**: Combine data from hundreds of small scanning runs into a single massive database.
- **Space Carving**: Uses raycast "miss" data to intelligently carve away incorrect geometry (e.g., removing ceilings over open terrain).
- **Unified Database**: Stores points and rays in a single, efficient binary format (`.db`).
- **GLB Export**: Exports directly to binary glTF (`.glb`) with vertex colors, ready for Godot, Blender, or Unity.
- **Interactive CLI**: Easy-to-use menu system for managing multiple map databases.

## Workflow

1.  **Scan**: Run the Portal script in Battlefield. It will log raycast hits (terrain surface) and misses (empty space) to a log file.
2.  **Ingest**: Run `meshtool`. It detects the log file, extracts the data, and merges it into your local database.
3.  **Mesh**: The tool automatically generates a Delaunay triangulation of the points.
4.  **Carve**: It uses the "miss" rays to prune triangles that intersect known empty space, fixing topology errors.
5.  **Export**: The final mesh is saved as a `.glb` file.

## Scanning Strategy (Important!)

The quality of your mesh depends entirely on how you collect data with the Portal script. Because the script has a runtime memory limit (~9000 raycasts before crashing), you cannot scan the whole map in high detail in one go. You must use a **progressive** approach:

1.  **Wide & Rough**: Start with a very wide scale and a large step count (e.g., **256 step** centered on `0,0`).
    - This gives you a low-detail "satellite view" of the entire map.
    - Run this a few times. The script randomly samples within the grid, so each run adds new points and slowly increases detail.
2.  **Targeted & Fine**: Once you identify a region of interest (e.g., a specific building or hill), get its coordinates (you can use the rough mesh in Godot to find them).
3.  **High Detail Pass**: Configure the script to scan _only_ that specific area with a much smaller step size (e.g., **0.1 step**).
    - This will generate a very high-resolution scan of just that area.
    - Repeat this process for every area you need high detail for.

The `meshtool` will automatically merge all these different scans (rough global data + fine local data) into a single cohesive mesh.

## Collaborative Mapping

The tool is also designed for team-based mapping. Since high-detail scanning of a large map can be time-consuming, you can split the work among multiple people:

1.  **Divide the Map**: Assign different areas (e.g., North/South or specific POIs) to different team members.
2.  **Scan Independently**: Each person collects data into their own local database.
3.  **Merge Results**: Share the `.db` files and use the `merge` command to combine them into a master database.

```powershell
meshtool merge user_a.db user_b.db master.db
```

## Usage

### Interactive Mode (Default)

Simply run the executable without arguments. You will be presented with a menu to select an existing database or create a new one.

```powershell
.\meshtool.exe
```

### Command Line Interface

The tool supports several commands for automation and advanced usage.

**Syntax:** `meshtool [command] [options]`

#### Commands

| Command  | Description                                                                                                            |
| :------- | :--------------------------------------------------------------------------------------------------------------------- |
| `run`    | **(Default)** Ingests logs, updates the database, and generates a mesh.                                                |
| `update` | Ingests logs and updates the database **ONLY**. Skips the expensive meshing process. Useful for rapid data collection. |
| `merge`  | Merges two separate databases into a new one.                                                                          |
| `help`   | Shows the help screen.                                                                                                 |

#### Options

| Option        | Description                                                                          |
| :------------ | :----------------------------------------------------------------------------------- |
| `-db <path>`  | Specify the database file to use directly (skips the interactive menu).              |
| `-log <path>` | Manually specify the log file path (defaults to auto-detection in Temp folder).      |
| `-out <path>` | Specify the output filename (defaults to `<dbname>.glb`).                            |
| `-nolog`      | Skip the log ingestion step (useful for re-meshing existing data with new settings). |

### Examples

**Standard Run (Auto-detect log, update DB, generate mesh):**

```powershell
meshtool run -db terrain.db
```

**Quick Update (Ingest log only, skip meshing):**

```powershell
meshtool update -db terrain.db
```

**Re-generate mesh from existing DB without checking logs:**

```powershell
meshtool run -db terrain.db -nolog
```

**Merge two databases (e.g., collaborating with a friend):**

```powershell
meshtool merge my_scan.db friend_scan.db combined_map.db
```

## Technical Details

- **Meshing Algorithm**: Uses a custom implementation of the **Bowyer-Watson** algorithm for global Delaunay triangulation.
- **Optimization**: Implements a **Triangle Quadtree** to accelerate raycast intersection tests from $O(N)$ to $O(\log N)$.
- **Data Storage**: Custom binary format designed for speed and compactness.

## Requirements

- .NET 10.0 Runtime (or self-contained executable)
- Windows OS (due to file path conventions for Portal logs)
